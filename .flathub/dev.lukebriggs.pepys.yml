app-id: dev.lukebriggs.pepys
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
base: io.qt.qtwebengine.BaseApp
base-version: '5.15'
command: runner.sh
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --device=dri
  # For user to choose journal directory
  - --filesystem=home
  # To access online content from journals
  - --share=network
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
cleanup-commands:
  - /app/cleanup-BaseApp.sh
modules:
  - name: pepys
    buildsystem: simple
    build-commands:
      - mkdir -p /app/src
      - cp  -r ./src/main /app/src
      - mkdir -p /app/share/metainfo
      - cp dev.lukebriggs.pepys.appdata.xml /app/share/metainfo/
      - mkdir -p /app/share/applications
      - cp dev.lukebriggs.pepys.desktop /app/share/applications/
      - mkdir -p /app/share/icons/hicolor/scalable/apps
      - cp -r ./src/main/resources/base/icons/appicons/base/* /app/share/icons/hicolor
      - cp -r ./src/main/resources/base/icons/appicons/hires/* /app/share/icons/hicolor
      - cp ./dev.lukebriggs.pepys.svg /app/share/icons/hicolor/scalable/apps/
    sources:
      - type: git
        commit: 20b07a631f0b15f84cf731a18bf47697599595b8
        tag: v1.2.0
        url: https://github.com/LukeBriggsDev/Pepys

  - python3-requirements.json

  - name: pyqt-deps
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    modules:
      - python3-PyQt-builder.json
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/50/24/743c4dd6a93d25570186a7940c4f072db1cf3fa919169b0ba598fcfc820a/PyQt6_sip-13.1.0.tar.gz
        sha256: 7c31073fe8e6cb8a42e85d60d3a096700a9047c772b354d6227dfe965566ec8a

  - name: pyqt6
    build-options:
      env:
        - QMAKEPATH=/app/lib
      arch:
        aarch64:
          config-opts:
            - --disable-feature=PyQt_Desktop_OpenGL
    cleanup:
      - /share/sip
    config-opts:
      - --confirm-license
      - --no-designer-plugin
      - --no-qml-plugin
      - --no-python-dbus
      - --no-tools
      - --enable=QtCore
      - --enable=QtGui
      - --enable=QtNetwork
      - --enable=QtWidgets
      - --enable=QtWebChannel
      - --enable=QtPrintSupport
      - --bindir=/app/bin
      - --destdir=/app/lib/python3.8/site-packages
      - --sipdir=/app/share/sip/PyQt6
      - --stubsdir=/app/lib/python3.8/site-packages/PyQt6
      - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.8/'
      - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.8/'
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/49/34/bd5a65ffc1a887d8d26f59f7993bb2f9abef3085c21dc74f03e3e834e57a/PyQt6-6.2.1.tar.gz
        sha256: d603a5c8effccc9174b3f43834256401a61ea40f2338306ca22fb6a1e870b89c
      - type: script
        commands:
          - processed=`sed -e 's|prefix|sysroot|' <<< $@`
          - python3 configure.py $processed
        dest-filename: configure


  - name: pyqt-webengine
    build-options:
      cppflags: "-I/app/include/QtWebEngine -I/app/include/QtWebEngineCore -I/app/include/QtWebEngineWidgets -I/usr/include/python3.8"
      env:
        - QMAKEPATH=/app/lib
    config-opts:
      - --concatenate
      - --no-qsci-api
      - --no-dist-info
      - --no-sip-files
      - --destdir=/app/lib/python3.8/site-packages/PyQt6
      - --stubsdir=/app/lib/python3.8/site-packages/PyQt6
      - QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.8/'
      - QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.8/'
      - QMAKE_INCDIR+=/app/include/QtWebEngine
      - QMAKE_INCDIR+=/app/include/QtWebEngineCore
      - QMAKE_INCDIR+=/app/include/QtWebEngineWidgets
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/f7/ed/9af8ee0e44e110c2e5f368b6b23d9600549e70c2f74fea7f3086d682eb5e/PyQt6_WebEngine-6.2.1.tar.gz
        sha256: cedc28f5416f6d7cb612f20d1f1f8ea1bbe7ebb8bbaa3f7fcd56f0e9c41582851998be20c3
      - type: script
        dest-filename: configure
        commands:
          - processed=`sed -e 's|prefix|sysroot|' <<< $@`
          - python3 configure.py $processed

  - name: enchant
    cleanup:
      - '*.la'
      - '*.a'
    sources:
      - type: archive
        url: https://github.com/AbiWord/enchant/releases/download/v2.2.15/enchant-2.2.15.tar.gz
        sha256: 3b0f2215578115f28e2a6aa549b35128600394304bd79d6f28b0d3b3d6f46c03

  - name: pandoc
    buildsystem: simple
    build-commands:
      - install -D bin/pandoc /app/bin/pandoc
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/jgm/pandoc/releases/download/2.13/pandoc-2.13-linux-amd64.tar.gz
        sha256: 7404aa88a6eb9fbb99d9803b80170a3a546f51959230cc529c66a2ce6b950d4c
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/jgm/pandoc/releases/download/2.13/pandoc-2.13-linux-arm64.tar.gz
        sha256: 4f87bfe8a0a626ad0e17d26d42e99a1c0ed7d369cca00366c1b3d97525f57db5

  - name: kerberos
    subdir: src
    sources:
      - type: archive
        url: https://web.mit.edu/kerberos/dist/krb5/1.19/krb5-1.19.1.tar.gz
        sha256: fa16f87eb7e3ec3586143c800d7eaff98b5e0dcdf0772af7d98612e49dbeb20b

  - name: wkhtmltopdf
    buildsystem: simple
    build-commands:
      - ar x wkhtmltox_*.deb
      - tar -xf data.tar.xz
      - cp -r ./usr/local/* /app/
    cleanup:
      - /lib/libwkhtmltox.*
      - /bin/wkhtmltoimage
    sources:
      - type: file
        only-arches:
          - x86_64
        url: https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.buster_amd64.deb
        sha256: 3e7a93a2ae4a2dd5cccb1b7bcce0eb462c75f05efa314a29499dadfdc5ebc59e
      - type: file
        only-arches:
          - aarch64
        url: https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.buster_arm64.deb
        sha256: d2929792fdc95fa66d637ecbf9cd0dce874f53d783d5ddcf947a86c007c81c95

  - name: runner
    buildsystem: simple
    build-commands:
      - echo "python3 /app/src/main/python/main.py" > /app/bin/runner.sh
      - chmod +x /app/bin/runner.sh